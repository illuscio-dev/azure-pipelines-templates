steps:
  - task: DownloadSecureFile@1
    name: gitSSHKey
    displayName: 'Download git ssh key'
    inputs:
      secureFile: git_ssh_key.private

  - script: echo $(gitSSHKey.secureFilePath)
    displayName: Debug ssh key location

  # Build docker image, tag as latest and version.
  - script: |
      DOCKER_BUILDKIT=1 docker build \
      --no-cache \
      --build-arg GOPRIVATE=$GOPRIVATE \
      --secret id=git_key,src=$SSH_KEY_PATH \
      -t $REGISTRY_NAME/$SERVICE_NAME:$RELEASE_VERSION \
      -t $REGISTRY_NAME/$SERVICE_NAME:latest \
      .
    env:
      RELEASE_VERSION: $(RELEASE_VERSION)
      REGISTRY_NAME: $(CONTAINER_REGISTRY_NAME)
      GOPRIVATE: $(GOPRIVATE)
      SSH_KEY_PATH: $(gitSSHKey.secureFilePath)
      DOCKER_BUILDKIT: 1
    displayName: 'Building Docker Image'
